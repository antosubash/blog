---
title: "Setup terraform to create Azure Kubernetes (AKS) cluster and Azure Container Registry (ACR)"
excerpt: "This is the second part of the series where we will setup terraform to create Azure Kubernetes (AKS) cluster and Azure Container Registry (ACR)."
date: "2023-08-16T11:53:48.157Z"
videoId:
series: "Azure Kubernetes (AKS) Deployment for .Net"
part: 5
tags: ["aks", "azure", "kubernetes", "terraform", "acr"]
---

## Table of contents

## Init terraform

```bash
terraform init
```

### Create main.tf

```bash
new-item main.tf
```

### create variables.tf

```bash
new-item variables.tf
```

### Create terraform.tfvars

```bash
new-item terraform.tfvars
```

### Create output.tf

```bash
new-item output.tf
```

### Create provider.tf

```bash
new-item provider.tf
```

## Create variables and outputs

### Add the following code to variables.tf

```bash
variable "location" {
  default     = "westeurope"
  description = "The Azure Region in which all resources should be created."
  type        = string
}

variable "resource_group_name" {
  default     = "projectname-dev-rg"
  description = "The name of the resource group in which all resources should be created."
  type        = string
}

variable "resource_group_tags" {
  default = {
    environment = "dev",
    project     = "projectname"
  }
  description = "A map of tags to add to all resources for this environment."
  type        = map(string)

  validation {
    condition     = length(keys(var.resource_group_tags)) == 2
    error_message = "The resource_group_tags map must contain exactly two elements."
  }

  validation {
    condition     = contains(keys(var.resource_group_tags), "environment")
    error_message = "The resource_group_tags map must contain a key named \"environment\"."
  }

  validation {
    condition     = contains(keys(var.resource_group_tags), "project")
    error_message = "The resource_group_tags map must contain a key named \"project\"."
  }
}

variable "letsencrypt_email" {
  default     = ""
  description = "The email address to use for Let's Encrypt."
  type        = string

  validation {
    condition     = can(regex("^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$", var.letsencrypt_email))
    error_message = "The letsencrypt_email variable must be a valid email address."
  }
}

variable "cloudflare_domain_name" {
  default     = ""
  description = "The domain name to use for Let's Encrypt."
  type        = string

  validation {
    condition     = can(regex("^[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$", var.cloudflare_domain_name))
    error_message = "The cloudflare_domain_name variable must be a valid domain name."
  }
}

variable "cloudflare_zone_id" {
  default     = ""
  description = "The Cloudflare Zone ID for the domain name."
  type        = string

  validation {
    condition     = length(var.cloudflare_zone_id) > 0
    error_message = "The cloudflare_zone_id variable must be a valid Cloudflare Zone ID."
  }
}

variable "cloudflare_api_token" {
  default    = ""
  description = "The Cloudflare API Token for the domain name."
  type        = string

  validation {
    condition     = length(var.cloudflare_api_token) > 0
    error_message = "The cloudflare_api_token variable must be a valid Cloudflare API Token."
  }
}
```

### Add the following code to output.tf

```bash
output "resource_group_id" {
  value = azurerm_resource_group.rg.id
}

output "resource_group_name" {
  value = azurerm_resource_group.rg.name
}

output "resource_group_location" {
  value = azurerm_resource_group.rg.location
}

output "resource_group_tags" {
  value = azurerm_resource_group.rg.tags
}

output "acr_id" {
  value = azurerm_container_registry.acr.id
}

output "acr_name" {
  value = azurerm_container_registry.acr.name
}

output "acr_login_server" {
  value = azurerm_container_registry.acr.login_server
}

output "acr_admin_username" {
  value = azurerm_container_registry.acr.admin_username
}

output "acr_admin_password" {
  value = azurerm_container_registry.acr.admin_password
  sensitive = true
}

output "aks_id" {
  value = azurerm_kubernetes_cluster.aks.id
}

output "aks_name" {
  value = azurerm_kubernetes_cluster.aks.name
}

output "aks_location" {
  value = azurerm_kubernetes_cluster.aks.location
}

output "aks_node_resource_group" {
  value = azurerm_kubernetes_cluster.aks.node_resource_group
}

output "aks_dns_prefix" {
  value = azurerm_kubernetes_cluster.aks.dns_prefix
}

output "aks_kube_admin_config" {
  value = azurerm_kubernetes_cluster.aks.kube_admin_config_raw
  sensitive = true
}

output "aks_kube_config" {
  value = azurerm_kubernetes_cluster.aks.kube_config_raw
  sensitive = true
}

output "aks_identity" {
  value = azurerm_kubernetes_cluster.aks.identity
}
```

## Add the following code to main.tf

```bash
# Configure the Azure provider
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0.2"
    }

    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = ">= 2.0.0"
    }

    helm = {
      source  = "hashicorp/helm"
      version = "~> 2.0.0"
    }

    random = {
      source  = "hashicorp/random"
      version = "~> 3.0.0"
    }

    cloudflare = {
      source  = "cloudflare/cloudflare"
      version = "~> 3.0"
    }

    local = {
      source  = "hashicorp/local"
      version = "~> 2.0.0"
    }
  }
  required_version = ">= 1.1.0"
}

provider "azurerm" {
  features {}
}

locals {
  name_suffix = "${var.resource_group_tags["project"]}-${var.resource_group_tags["environment"]}"
}

resource "azurerm_resource_group" "rg" {
  name     = "${local.name_suffix}-rg"
  location = var.location
  tags     = var.resource_group_tags
}

// create acr

resource "azurerm_container_registry" "acr" {
  name                = "${replace(local.name_suffix, "-", "")}acr"
  resource_group_name = azurerm_resource_group.rg.name
  location            = azurerm_resource_group.rg.location
  sku                 = "Basic"
  admin_enabled       = true
  tags                = var.resource_group_tags
}

provider "kubernetes" {
  host                   = azurerm_kubernetes_cluster.aks.kube_config.0.host
  client_certificate     = base64decode(azurerm_kubernetes_cluster.aks.kube_config.0.client_certificate)
  client_key             = base64decode(azurerm_kubernetes_cluster.aks.kube_config.0.client_key)
  cluster_ca_certificate = base64decode(azurerm_kubernetes_cluster.aks.kube_config.0.cluster_ca_certificate)
}

// create helm provider

provider "helm" {
  kubernetes {
    host                   = azurerm_kubernetes_cluster.aks.kube_config.0.host
    client_certificate     = base64decode(azurerm_kubernetes_cluster.aks.kube_config.0.client_certificate)
    client_key             = base64decode(azurerm_kubernetes_cluster.aks.kube_config.0.client_key)
    cluster_ca_certificate = base64decode(azurerm_kubernetes_cluster.aks.kube_config.0.cluster_ca_certificate)
  }
}

provider "cloudflare" {
  api_token = var.cloudflare_api_token
}

provider "local" {
}


resource "local_file" "kube_config" {
  filename = "${path.module}/configs/${local.name_suffix}.config"
  content  = <<EOT
${azurerm_kubernetes_cluster.aks.kube_config_raw}
EOT
}

// attach acr to aks

resource "azurerm_role_assignment" "aks_acr_role_assignment" {
  depends_on           = [azurerm_kubernetes_cluster.aks]
  scope                = azurerm_container_registry.acr.id
  role_definition_name = "AcrPull"
  principal_id         = azurerm_kubernetes_cluster.aks.kubelet_identity[0].object_id
}

// create static ip inside aks resource group

resource "azurerm_public_ip" "aks_static_ip" {
  depends_on          = [azurerm_kubernetes_cluster.aks]
  name                = "${local.name_suffix}-aks-static-ip"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_kubernetes_cluster.aks.node_resource_group
  allocation_method   = "Static"
  sku                 = "Standard"
  tags                = var.resource_group_tags
}

// add cloudflare cname dns record for aks static ip

resource "cloudflare_record" "aks_static_ip_dns" {
  depends_on = [azurerm_public_ip.aks_static_ip]
  zone_id    = var.cloudflare_zone_id
  name       = "${var.resource_group_tags["project"]}.${var.cloudflare_domain_name}"
  value      = azurerm_public_ip.aks_static_ip.ip_address
  type       = "A"
  proxied    = false
  ttl        = 1
}

// add cloudflare cname dns record for aks static ip

resource "cloudflare_record" "aks_static_ip_dns_cname" {
  depends_on = [azurerm_public_ip.aks_static_ip]
  zone_id    = var.cloudflare_zone_id
  name       = "*.${var.resource_group_tags["project"]}.${var.cloudflare_domain_name}"
  value      = "${var.resource_group_tags["project"]}.${var.cloudflare_domain_name}"
  type       = "CNAME"
  proxied    = false
  ttl        = 1
}

// create local variable for aks namespace

locals {
  aks_namespace = "${var.resource_group_tags["project"]}-${var.resource_group_tags["environment"]}-ingress-nginx"
}

// create aks ingress namespace

resource "kubernetes_namespace" "ingress_namespace" {
  depends_on = [azurerm_kubernetes_cluster.aks]
  metadata {
    name = "${local.aks_namespace}"
  }
}

// deploy nginx ingress controller to aks with static ip

resource "helm_release" "nginx_ingress" {
  depends_on = [azurerm_public_ip.aks_static_ip]
  name       = "nginx-ingress"
  repository = "https://kubernetes.github.io/ingress-nginx"
  chart      = "ingress-nginx"
  namespace  = "${local.aks_namespace}"
  version    = "4.7.0"

  set {
    name  = "controller.service.loadBalancerIP"
    value = azurerm_public_ip.aks_static_ip.ip_address
  }

  set {
    name  = "controller.service.externalTrafficPolicy"
    value = "Local"
  }
}

// deploy cert-manager to aks

resource "helm_release" "cert_manager" {
  depends_on = [azurerm_kubernetes_cluster.aks]
  name       = "cert-manager"
  repository = "https://charts.jetstack.io"
  chart      = "cert-manager"
  namespace  = "${local.aks_namespace}"
  version    = "1.12.0"

  set {
    name  = "installCRDs"
    value = true
  }
}
```

## Create terraform.tfvars

```bash
location = "westeurope"
resource_group_name = "projectname-dev-rg"
resource_group_tags = {
  environment = "dev"
  project     = "projectname"
}
```

## 